<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>BKK Közút Élő Térkép</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        .counter {
            position: absolute; top: 15px; left: 60px; z-index: 1000;
            background: rgba(255,255,255,0.9); padding: 10px 20px;
            border-radius: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            font-weight: bold; font-size: 16px;
        }
    </style>
</head>
<body>

<div class="counter" id="stat">Események betöltése...</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([47.4979, 19.0402], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const api_url = 'https://api.allorigins.win/raw?url=https://kozut.bkkinfo.hu/api/changes';

    fetch(api_url)
        .then(res => res.json())
        .then(data => {
            document.getElementById('stat').innerText = `Aktuális események: ${data.length} DB`;
            
            data.forEach(event => {
                event.effects.forEach(effect => {
                    if (effect.coordinates) {
                        try {
                            const coords = JSON.parse(effect.coordinates).map(c => {
                                const p = c.split(',');
                                return [parseFloat(p[0]), parseFloat(p[1])];
                            });

                            // Vonal rajzolása
                            L.polyline(coords, {
                                color: effect.code === 'lezaras' ? '#e74c3c' : '#f39c12',
                                weight: 6,
                                opacity: 0.8
                            }).addTo(map);

                            // Ikon elhelyezése a vonal elejére
                            const iconUrl = 'https://kozut.bkkinfo.hu' + effect.icon;
                            const bkkIcon = L.icon({
                                iconUrl: iconUrl,
                                iconSize: [32, 32],
                                iconAnchor: [16, 16]
                            });

                            L.marker(coords[0], {icon: bkkIcon})
                                .addTo(map)
                                .bindPopup(`<b>${effect.name}</b><br>Utca: ${effect.pivot.street || 'Nincs megadva'}`);
                                
                        } catch (e) { console.error("Kódolási hiba", e); }
                    }
                });
            });
        });
</script>
</body>
</html>
