<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Közös Közúti Térkép (BKK & Utinform)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        .legend {
            position: absolute; top: 15px; left: 60px; z-index: 1000;
            background: white; padding: 10px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<div class="legend" id="stat">Adatok betöltése...</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([47.1625, 19.5033], 8); // Országos nézet
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    fetch('./adatok.json')
        .then(res => res.json())
        .then(data => {
            const bkkCount = data.filter(i => i.source === 'BKK').length;
            const utinformCount = data.filter(i => i.source === 'Utinform').length;
            document.getElementById('stat').innerHTML = `<b>BKK:</b> ${bkkCount} | <b>Utinform:</b> ${utinformCount}`;

            data.forEach(item => {
                // 1. Ha Utinform (XML alapú) adat
                if (item.is_xml_event) {
                    L.marker([item.lat, item.lon], {
                        icon: L.icon({
                            iconUrl: 'https://kozut.bkkinfo.hu/img/pin/kis_aktiv_egyeb.png',
                            iconSize: [25, 25]
                        })
                    }).addTo(map).bindPopup("<b>Utinform esemény</b>");
                } 
                // 2. Ha BKK (JSON alapú) adat
                else if (item.effects) {
                    item.effects.forEach(effect => {
                        if (effect.coordinates) {
                            try {
                                const coords = JSON.parse(effect.coordinates).map(c => c.split(',').map(Number));
                                L.polyline(coords, {color: effect.code === 'lezaras' ? 'red' : 'orange', weight: 4}).addTo(map);
                                
                                const iconUrl = effect.icon.startsWith('http') ? effect.icon : `https://kozut.bkkinfo.hu${effect.icon}`;
                                L.marker(coords[0], {icon: L.icon({iconUrl: iconUrl, iconSize: [25, 25]})})
                                 .addTo(map).bindPopup(`<b>BKK: ${effect.name}</b>`);
                            } catch(e) {}
                        }
                    });
                }
            });
        });
</script>
</body>
</html>
