<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>BKK Élő Térkép</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .counter {
            position: absolute; top: 15px; left: 60px; z-index: 1000;
            background: white; padding: 10px 20px; border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-weight: bold;
            border: 2px solid #0052a4;
        }
        .popup-time { color: #666; font-size: 0.85em; margin-top: 5px; display: block; }
    </style>
</head>
<body>

<div class="counter" id="stat">BKK adatok betöltése...</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([47.4979, 19.0402], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);

    fetch('./adatok.json')
        .then(res => res.json())
        .then(data => {
            document.getElementById('stat').innerText = `BKK Események: ${data.length} DB`;
            
            data.forEach(event => {
                // Kimentjük a kezdési dátumot az eseményből
                const startDate = event.start_date || 'Nincs megadva';
                
                if (!event.effects) return;
                
                event.effects.forEach(effect => {
                    if (effect.coordinates) {
                        try {
                            const coords = JSON.parse(effect.coordinates).map(c => {
                                const p = c.split(',');
                                return [parseFloat(p[0]), parseFloat(p[1])];
                            });

                            // Vonal rajzolása
                            L.polyline(coords, {
                                color: effect.code === 'lezaras' ? '#d32f2f' : '#f57c00',
                                weight: 5,
                                opacity: 0.8
                            }).addTo(map);

                            const iconUrl = effect.icon.startsWith('http') 
                                ? effect.icon 
                                : `https://kozut.bkkinfo.hu${effect.icon}`;

                            const bkkIcon = L.icon({
                                iconUrl: iconUrl,
                                iconSize: [30, 30],
                                iconAnchor: [15, 15]
                            });

                            // Marker lerakása a dátummal kiegészítve
                            L.marker(coords[0], {icon: bkkIcon})
                                .addTo(map)
                                .bindPopup(`
                                    <div style="min-width: 160px;">
                                        <b style="font-size: 1.1em; color: #0052a4;">${effect.name}</b><br>
                                        <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0;">
                                        <b>Helyszín:</b> ${effect.pivot.street || 'Ismeretlen utca'}<br>
                                        <span class="popup-time"><b>Bekerülés ideje:</b><br>${startDate}</span>
                                    </div>
                                `);
                        } catch (e) { console.warn("Hiba a koordinátákkal"); }
                    }
                });
            });
        })
        .catch(err => {
            document.getElementById('stat').innerText = "Várakozás az adatokra...";
        });
</script>
</body>
</html>
